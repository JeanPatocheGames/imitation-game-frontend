<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Imitation Game - Round</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex; height: 100vh; background: #222;
    color: white;
  }
  #players {
    width: 250px; background: #333; padding: 10px;
    overflow-y: auto;
  }
  #players h2 {
    margin-top: 0;
  }
  #players ul {
    list-style: none; padding: 0;
  }
  #players li {
    margin: 5px 0; padding: 5px;
    background: #444; border-radius: 5px;
    display: flex; justify-content: space-between;
    align-items: center;
  }
  #main {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 20px;
  }
  video {
    max-width: 100%; max-height: 50vh;
    background: black;
  }
  #roundInfo {
    font-size: 24px; margin-bottom: 10px;
  }
  #controls {
    margin-top: 10px;
  }
  button {
    padding: 10px 20px; margin: 0 5px;
    font-size: 16px; border: none; border-radius: 5px;
    cursor: pointer;
  }
  button:disabled {
    background: #555; cursor: default;
  }
  .voteButtons button {
    margin-top: 10px;
  }
</style>
</head>
<body>
  <div id="players">
    <h2>Classement</h2>
    <ul id="playerList"></ul>
  </div>
  <div id="main">
    <div id="roundInfo">Round 1 / 3</div>
    <video id="video" controls muted>
      <source src="" type="video/mp4" />
      Ton navigateur ne supporte pas la vidéo.
    </video>
    <div id="controls">
      <button id="startRec">Démarrer l'enregistrement</button>
      <button id="stopRec" disabled>Arrêter</button>
      <button id="resetRec" disabled>Recommencer</button>
      <button id="validateRec" disabled>C'est parfait</button>
    </div>
    <div class="voteButtons" style="margin-top:20px;">
      <button id="voteTop">TOP (+2)</button>
      <button id="votePlus">+1</button>
      <button id="voteMinus">-1</button>
    </div>
  </div>

<script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
<script>
  const socket = io("https://imitation-game-server-uz6b.onrender.com"); // Remplace par ton backend

  let pseudo = prompt("Entrez votre pseudo :");
  while (!pseudo || pseudo.trim().length < 2) {
    pseudo = prompt("Pseudo invalide. Entrez votre pseudo :");
  }
  pseudo = pseudo.trim();

  socket.emit("joinGame", pseudo, (res) => {
    if (!res.success) {
      alert("Erreur : " + res.message);
      location.reload();
    } else {
      alert(res.isAdmin ? "Vous êtes admin" : "Vous êtes joueur");
    }
  });

  // UI Elements
  const playerList = document.getElementById("playerList");
  const roundInfo = document.getElementById("roundInfo");
  const video = document.getElementById("video");
  const startRec = document.getElementById("startRec");
  const stopRec = document.getElementById("stopRec");
  const resetRec = document.getElementById("resetRec");
  const validateRec = document.getElementById("validateRec");
  const voteTop = document.getElementById("voteTop");
  const votePlus = document.getElementById("votePlus");
  const voteMinus = document.getElementById("voteMinus");

  let mediaRecorder;
  let audioChunks = [];
  let hasVoted = false;

  function updatePlayerList(players) {
    playerList.innerHTML = "";
    players.forEach(p => {
      const li = document.createElement("li");
      li.textContent = `${p.pseudo} (${p.score} pts)`;
      if (p.isAdmin) li.textContent += " [ADMIN]";
      playerList.appendChild(li);
    });
  }

  socket.on("playersUpdate", updatePlayerList);

  socket.on("roundUpdate", data => {
    roundInfo.textContent = `Round ${data.currentRound} / ${data.totalRounds}`;
    video.src = data.videoURL;
    resetRecordingUI();
  });

  socket.on("gameStarted", () => {
    alert("La partie a commencé !");
  });

  // Enregistrement audio (simple)

  startRec.onclick = async () => {
    if (!navigator.mediaDevices) {
      alert("Votre navigateur ne supporte pas la capture audio.");
      return;
    }
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();
    audioChunks = [];
    startRec.disabled = true;
    stopRec.disabled = false;
    resetRec.disabled = true;
    validateRec.disabled = true;

    mediaRecorder.ondataavailable = e => {
      audioChunks.push(e.data);
    };
    mediaRecorder.onstop = e => {
      resetRec.disabled = false;
      validateRec.disabled = false;
    };
  };

  stopRec.onclick = () => {
    if (mediaRecorder) mediaRecorder.stop();
    startRec.disabled = false;
    stopRec.disabled = true;
  };

  resetRec.onclick = () => {
    audioChunks = [];
    startRec.disabled = false;
    stopRec.disabled = true;
    resetRec.disabled = true;
    validateRec.disabled = true;
  };

  validateRec.onclick = () => {
    // Ici, on simule l'envoi de l'imitation au backend
    socket.emit("validateImitation", pseudo);
    alert("Imitation validée !");
    validateRec.disabled = true;
  };

  // Votes

  function disableVoteButtons() {
    voteTop.disabled = true;
    votePlus.disabled = true;
    voteMinus.disabled = true;
  }

  voteTop.onclick = () => {
    if (hasVoted) return alert("Vous avez déjà voté ce round.");
    socket.emit("vote", { voter: pseudo, target: pseudo, voteType: "TOP" });
    disableVoteButtons();
    hasVoted = true;
  };
  votePlus.onclick = () => {
    if (hasVoted) return alert("Vous avez déjà voté ce round.");
    socket.emit("vote", { voter: pseudo, target: pseudo, voteType: "+1" });
    disableVoteButtons();
    hasVoted = true;
  };
  voteMinus.onclick = () => {
    if (hasVoted) return alert("Vous avez déjà voté ce round.");
    socket.emit("vote", { voter: pseudo, target: pseudo, voteType: "-1" });
    disableVoteButtons();
    hasVoted = true;
  };

  function resetRecordingUI() {
    startRec.disabled = false;
    stopRec.disabled = true;
    resetRec.disabled = true;
    validateRec.disabled = true;
    hasVoted = false;
    disableVoteButtons();
  }
</script>
</body>
</html>
